#======================================================================================================================
# ePages
#======================================================================================================================
package ePages::ePages;

use strict;

use DE_EPAGES::WebInterface::API::MessageCenter;
use DE_EPAGES::DataCache::API::Cache qw ( GetTouched ResetTouched UpdateLocal UpdateTouched );

use DE_EPAGES::Object::API::Factory qw (
    LoadRootObject
);

use ePages::LanguageInfo;

#======================================================================================================================
# §function     new
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       ePages->new();
#----------------------------------------------------------------------------------------------------------------------
# §description  Constructor
#----------------------------------------------------------------------------------------------------------------------
# §return       $Object | The new object instance | Object
#======================================================================================================================
sub new {
    my $class = shift;

    my $self = bless({}, $class);

    return $self;
}

#======================================================================================================================
# §function     open
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $ePages->open()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#======================================================================================================================
sub open {
    my $self = shift;

print "epages.open\n";
    $self->reset();

    my $MessageCenter = 
        DE_EPAGES::WebInterface::API::MessageCenter->new(
            AppServerAddress => '192.168.56.10',
            AppServerPort    => '10042',
            PoolName         => 'DefaultPool',
            Priority         => 0,
        );

    $MessageCenter->connect();
    $MessageCenter->sendInitialFreeRequest();
    $self->{'MessageCenter'} = $MessageCenter;

    return;
}

#======================================================================================================================
# §function     close
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $ePages->close()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#======================================================================================================================
sub close {
    my $self = shift;

print "epages.close\n";
    my $MessageCenter = $self->{'MessageCenter'};
    if (defined $MessageCenter) {
print "messagecenter.close\n";
        $MessageCenter->close();
        $self->{'MessageCenter'} = undef;
    }

    $self->reset();

    return;
}

#======================================================================================================================
# §function     updateCache
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $ePages->updateCache()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#======================================================================================================================
sub updateCache {
    my $self = shift;

print "epages.updateCache\n";
    my $MessageCenter = $self->{'MessageCenter'};
    if (defined $MessageCenter) {
print "messagecenter.sendIdleRequest\n";
        $MessageCenter->sendIdleRequest();
        ResetTouched();
    }

    return;
}

#======================================================================================================================
# §function     getMessageCenter
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $MessageCenter = $ePages->getMessageCenter()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §return       $MessageCenter | The MessageCenter object | object
#======================================================================================================================
sub getMessageCenter {
    my $self = shift;

    return $self->{'MessageCenter'};
}

#======================================================================================================================
# §function     reset
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $ePages->reset()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#======================================================================================================================
sub reset {
    my $self = shift;

print "epages.reset\n";
    $self->{'Store'}            = undef;
    $self->{'System'}           = undef;
    $self->{'Object'}           = undef;
    $self->{'LanguageInfo'}     = undef;

    return;
}

#======================================================================================================================
# §function     isStoreActive
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Active = $ePages->isStoreActive()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §return       $isActive | TRUE is there is a Store active | boolean
#======================================================================================================================
sub isStoreActive {
    my $self = shift;

    return defined $self->{'System'};
}

#======================================================================================================================
# §function     setStore
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $ePages->setStore( 'Store' )
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §input        $Store | Name of the Store to link | string
#======================================================================================================================
sub setStore {
    my $self = shift;

    my ( $Store ) = @_;

    $self->reset();
    $self->{'Store'} = $Store;

    return;
}

#======================================================================================================================
# §function     getStore
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Store = $ePages->getStore()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §return       $Store | The current Store | object
#======================================================================================================================
sub getStore {
    my $self = shift;

    return $self->{'Store'};
}

#======================================================================================================================
# §function     connect
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $ePages->connect()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §input        $Store | Name of the Store to link | string
#======================================================================================================================
sub connect {
    my $self = shift;

    if ( defined $self->{'Store'} ) {
        $self->{'System'} = LoadRootObject();
        $self->loadLanguageInfo();
    }

    return;
}

#======================================================================================================================
# §function     getSystem
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $System = $ePages->getSystem()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §return       $System | The current Store System object | object
#======================================================================================================================
sub getSystem {
    my $self = shift;

    return $self->{'System'};
}

#======================================================================================================================
# §function     setObject
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $ePages->setObject( $Object )
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §input        $Object | Set the current Object | object
#======================================================================================================================
sub setObject {
    my $self = shift;

    my ( $Object ) = @_;

    $self->{'Object'} = $Object;

    return;
}

#======================================================================================================================
# §function     getObject
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Object = $ePages->getObject()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §return       $Object | The current object | object
#======================================================================================================================
sub getObject {
    my $self = shift;

    return $self->{'Object'};
}

#======================================================================================================================
# §function     setLanguageInfo
# §state        private
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Shell->setLanguageInfo()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#======================================================================================================================
sub loadLanguageInfo {
    my $self = shift;

    if ( $self->isStoreActive() ) {
        $self->{'LanguageInfo'} = ePages::LanguageInfo->new( $self->getSystem() );
    } else {
        $self->{'LanguageInfo'} = undef;
    }

    return;
}

#======================================================================================================================
# §function     getLanguageInfo
# §state        private
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $sPages->getLanguageInfo()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#======================================================================================================================
sub getLanguageInfo {
    my $self = shift;

    return $self->{'LanguageInfo'};
}

1;
