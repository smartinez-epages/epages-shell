#======================================================================================================================
# §package      Shell::Console
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#======================================================================================================================
package Shell::Console;

use strict ;

use Term::ReadKey;
use Data::Dumper;

$Data::Dumper::Indent = 1 ;

#======================================================================================================================
# §function     new
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       my $console = Shell::Console->new( $hOptions ) ;
#----------------------------------------------------------------------------------------------------------------------
# §description  Console constructor
#----------------------------------------------------------------------------------------------------------------------
# §input        $hOptions | Construction options | hash.ref
#----------------------------------------------------------------------------------------------------------------------
# §return       $Shell | New object instance | object
#======================================================================================================================
sub new {
    my $class = shift;

    my ( $hOptions ) = @_ ;

    system( 'stty erase ^H' ) ;

    my $hAttributes = {
        'Pager'         => 1,
        'PagerCmd'      => 0,
        'PagerMax'      => 0,
        'PagerCount'    => 0
    } ;
    
    return bless( { %$hOptions, %$hAttributes }, $class );
}


#======================================================================================================================
# §function     resetPager
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Console->resetPager()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#======================================================================================================================
sub resetPager() {
    my $self = shift;

    $self->{'PagerCmd'} = $self->{'Pager'} ;
    if ( $self->{'PagerCmd'} ) {
        $self->{'PagerCount'} =  0 ;
        $self->{'PagerMax'} =  (GetTerminalSize())[1] - 3 ;
    }

    return ;
}

#======================================================================================================================
# §function     prompt
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Input = $Console->prompt( $Format, ... )
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §input        $Format | TODO | string
#----------------------------------------------------------------------------------------------------------------------
# §return       $Input | TODO | string
#======================================================================================================================
sub prompt {
    my $self = shift;

    my $Format = shift ;
    printf( $Format, @_ ) ;
    my $Input = ReadLine(0) ;
    $Input =~ s/^\s+|\s+$//g ;
    
    return $Input ;
}

#======================================================================================================================
# §function     error
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Console->error( ... )
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §input        $Data | TODO | any
#======================================================================================================================
sub error {
    my $self = shift;

    printf( "\nERROR : @_\n" ) ;

    return ;
}

#======================================================================================================================
# §function     dump
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Console->dump( ... )
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §input        $Data | TODO | any
#======================================================================================================================
sub dump {
    my $self = shift;

    print Dumper( @_ ) ;

    return ;
}

#======================================================================================================================
# §function     debug
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Console->debug( $Format, ... )
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §input        $Format | TODO | string
#======================================================================================================================
sub debug {
    my $self = shift;

    if ( $self->{'Debug'} ) {
        my $Format = shift ;
        $self->output( "DEBUG: $Format", @_ ) ;
    }

    return ;
}

#======================================================================================================================
# §function     output
# §state        public
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Console->output( $Format, ... )
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §input        $Format | TODO | string
#----------------------------------------------------------------------------------------------------------------------
# §return       $Name | TODO | type
#======================================================================================================================
sub output {
    my $self = shift;

    my $Format = shift ;
    printf( $Format, @_ ) ;

    return $self->_checkPager() ;
}

#======================================================================================================================
# §function     _checkPager
# §state        private
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Console->_checkPager()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §return       $Continue | TODO | boolean
#======================================================================================================================
sub _checkPager() {
    my $self = shift;

    if ( $self->{'PagerCmd'} ) {
        if ( ++$self->{'PagerCount'} >= $self->{'PagerMax'} ) {
            $self->{'PagerCount'} = 0 ;
            my $KeyPressed = $self->_pauseOutput() ;
            if ( $KeyPressed == 27 ) {
                return 0 ;
            } elsif ( $KeyPressed == 10 ) {
                $self->{'PagerCmd'} = 0 ;
            }
            
        } 
    };

    return 1 ;
}

#======================================================================================================================
# §function     _pauseOutput
# §state        private
#----------------------------------------------------------------------------------------------------------------------
# §syntax       $Console->_pauseOutput()
#----------------------------------------------------------------------------------------------------------------------
# §description  TODO
#----------------------------------------------------------------------------------------------------------------------
# §return       $KeyPressed | TODO | char
#======================================================================================================================
sub _pauseOutput() {
    my $self = shift;

    print "<<<< Press any key to continue, RETURN to disable pager, ESC to stop output >>>>";

    ReadMode 'raw';
    my $KeyPressed = ReadKey(0);
    ReadMode 'restore';

    print "\r                                                                                     \r";

    return ord( $KeyPressed );
}

1;
